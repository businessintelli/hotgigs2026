# ══════════════════════════════════════════════════════════════════════
# HotGigs 2026 - Full Stack Docker Compose
# Usage:
#   docker compose up -d              # Start all services
#   docker compose up -d --build      # Rebuild and start
#   docker compose logs -f app        # Follow app logs
#   docker compose down -v            # Stop and remove volumes
# ══════════════════════════════════════════════════════════════════════

services:
  # ── Application Server ─────────────────────────────────────────────
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: hotgigs-app
    restart: unless-stopped
    ports:
      - "${APP_PORT:-8000}:8000"
    env_file:
      - .env.docker
    environment:
      - DATABASE_URL=postgresql+asyncpg://hotgigs:hotgigs2026@postgres:5432/hotgigs_db
      - DATABASE_SYNC_URL=postgresql://hotgigs:hotgigs2026@postgres:5432/hotgigs_db
      - REDIS_URL=redis://redis:6379/0
      - RABBITMQ_URL=amqp://hotgigs:hotgigs2026@rabbitmq:5672/
      - ELASTICSEARCH_URL=http://elasticsearch:9200
    volumes:
      - app_uploads:/app/uploads
      - app_logs:/app/logs
      - app_data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - hotgigs-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ── PostgreSQL Database ────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    container_name: hotgigs-postgres
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_USER: hotgigs
      POSTGRES_PASSWORD: hotgigs2026
      POSTGRES_DB: hotgigs_db
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - hotgigs-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hotgigs -d hotgigs_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── Redis Cache ────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: hotgigs-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    networks:
      - hotgigs-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── RabbitMQ Message Broker ────────────────────────────────────────
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: hotgigs-rabbitmq
    restart: unless-stopped
    ports:
      - "${RABBITMQ_PORT:-5672}:5672"
      - "${RABBITMQ_MGMT_PORT:-15672}:15672"
    environment:
      RABBITMQ_DEFAULT_USER: hotgigs
      RABBITMQ_DEFAULT_PASS: hotgigs2026
      RABBITMQ_DEFAULT_VHOST: /
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - hotgigs-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 15s
      timeout: 10s
      retries: 5

  # ── Elasticsearch (Search & Analytics) ─────────────────────────────
  elasticsearch:
    image: elasticsearch:8.12.0
    container_name: hotgigs-elasticsearch
    restart: unless-stopped
    ports:
      - "${ES_PORT:-9200}:9200"
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - xpack.security.enrollment.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    volumes:
      - es_data:/usr/share/elasticsearch/data
    networks:
      - hotgigs-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 20s
      timeout: 10s
      retries: 5

  # ── Nginx Reverse Proxy ────────────────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: hotgigs-nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./docker/ssl:/etc/nginx/ssl
    depends_on:
      app:
        condition: service_healthy
    networks:
      - hotgigs-network

# ── Volumes ──────────────────────────────────────────────────────────
volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  es_data:
    driver: local
  app_uploads:
    driver: local
  app_logs:
    driver: local
  app_data:
    driver: local

# ── Networks ─────────────────────────────────────────────────────────
networks:
  hotgigs-network:
    driver: bridge
    name: hotgigs-network
